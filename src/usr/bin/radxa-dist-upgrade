#!/usr/bin/env bash

main() {
    set -euo pipefail
    shopt -s nullglob

    export FLAG="1"

    # shellcheck source=src/usr/lib/radxa-dist-upgrade/common.sh
    source "/usr/lib/radxa-dist-upgrade/common.sh"

    lib="/usr/lib/radxa-dist-upgrade/$(lsb_release -c | awk -F'\t' '{print $2}').sh"
    if [[ -f "$lib" ]]; then
        # shellcheck source=src/usr/lib/radxa-dist-upgrade/bullseye.sh
        source "$lib"
    else
        echo "Unsupported distribution"
        return 1
    fi

    menu_init
    menu_add checks "Check for upgrade"
    menu_add setup_source_list "Setup source list"
    menu_add pre_system_upgrade "Pre system upgrade"
    menu_add system_upgrade "System upgrade"
    menu_add post_system_upgrade "Post system upgrade"
    menu_show "Please select an operation below:"
}

export STEP="0"
DEBUG="${DEBUG:-false}"
SCRIPT_DIR="$(dirname "$(realpath "$0")")"

if [[ -f "$SCRIPT_DIR/../src/lib/librtui/tui.sh" ]]
then
    # shellcheck source=externals/librtui/src/lib/librtui/tui.sh
    source "$SCRIPT_DIR/../src/lib/librtui/tui.sh"
else
    # shellcheck source=externals/librtui/src/lib/librtui/tui.sh
    source "/usr/lib/librtui/tui.sh"
fi

tui_start main "radxa-dist-upgrade"
